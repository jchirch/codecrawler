@if (loading()) {
  <p class="status-msg">Loading campaign‚Ä¶</p>
} @else if (error()) {
  <div class="error-banner">{{ error() }}</div>
} @else if (campaign()) {
  <div class="chat-page">

    <!-- Compact campaign header (full-width) -->
    <div class="chat-header">
      <a class="back-link" routerLink="/campaigns">‚Üê Campaigns</a>
      <div class="header-info">
        <span class="campaign-name">{{ campaign()!.name }}</span>
        <div class="badges">
          <span class="badge theme">{{ campaign()!.theme }}</span>
          <span class="badge difficulty" [class]="'diff-' + campaign()!.difficulty.toLowerCase()">
            {{ campaign()!.difficulty }}
          </span>
        </div>
      </div>
      <div class="invite-block">
        <span class="invite-label">Invite:</span>
        <code class="invite-code">{{ campaign()!.invite_code }}</code>
        <button class="copy-btn" (click)="copyInviteCode()" [class.copied]="codeCopied()">
          {{ codeCopied() ? '‚úì Copied' : 'üìã Copy' }}
        </button>
      </div>
    </div>

    <!-- Body: chat main + dice sidebar -->
    <div class="chat-body">

      <!-- Chat main column -->
      <div class="chat-main">
        <!-- Scrollable messages -->
        <div class="messages-area" #messageList>
          @if (messages().length === 0) {
            <div class="empty-state">
              <p>üó∫Ô∏è No messages yet. Start your adventure!</p>
            </div>
          }
          @for (msg of messages(); track msg.id) {
            <div class="message-row" [class.own]="isCurrentUser(msg.user_id)" [class.dice-msg]="msg.content.startsWith('üé≤')">
              <div class="message-bubble">
                <div class="message-meta">
                  <span class="message-name">{{ msg.display_name }}</span>
                  <span class="message-time">{{ msg.created_at | date:'shortTime' }}</span>
                </div>
                <div class="message-content">{{ msg.content }}</div>
              </div>
            </div>
          }
        </div>

        <!-- Input area -->
        <div class="input-area">
          <textarea
            [(ngModel)]="messageContent"
            (keydown)="onKeydown($event)"
            placeholder="Type your message‚Ä¶ (Enter to send, Shift+Enter for new line)"
            [disabled]="sending()"
            rows="1"
          ></textarea>
          <button class="send-btn" (click)="sendMessage()" [disabled]="sending() || !messageContent.trim()">
            {{ sending() ? '‚Ä¶' : '‚û§' }}
          </button>
        </div>
      </div>

      <!-- Dice roller sidebar -->
      <div class="dice-sidebar">
        <div class="dice-panel">
          <h3 class="dice-title">üé≤ Dice Roller</h3>

          <!-- Die type selector -->
          <div class="dice-types">
            @for (d of DICE_TYPES; track d) {
              <button
                class="die-btn"
                [class.selected]="selectedDie() === d"
                (click)="selectDie(d)"
              >d{{ d }}</button>
            }
          </div>

          <!-- Count + modifier -->
          <div class="dice-controls">
            <div class="control-group">
              <label class="control-label">Dice</label>
              <input class="control-input" type="number" [ngModel]="diceCount()" (ngModelChange)="diceCount.set($event)" min="1" max="20" />
            </div>
            <div class="control-group">
              <label class="control-label">Modifier</label>
              <input class="control-input" type="number" [ngModel]="diceModifier()" (ngModelChange)="diceModifier.set($event)" min="-100" max="100" />
            </div>
          </div>

          <!-- Roll button -->
          <button class="btn-roll" (click)="rollDice()" [disabled]="rolling()">
            {{ rolling() ? 'Rolling‚Ä¶' : 'Roll ' + diceCount() + 'd' + selectedDie() + (diceModifier() !== 0 ? (diceModifier() > 0 ? '+' : '') + diceModifier() : '') }}
          </button>

          <!-- Result display -->
          @if (diceResult()) {
            <div class="dice-result">
              <div class="result-notation">{{ diceResult()!.notation }}</div>
              <div class="result-rolls">
                @for (r of diceResult()!.rolls; track $index) {
                  <span class="roll-pip">{{ r }}</span>
                }
              </div>
              @if (diceModifier() !== 0) {
                <div class="result-modifier">{{ diceModifier() > 0 ? '+' : '' }}{{ diceModifier() }} modifier</div>
              }
              <div class="result-total">{{ diceResult()!.total }}</div>
              <button class="btn-send-dice" (click)="sendDiceToChat()" [disabled]="sendingDice()">
                {{ sendingDice() ? 'Sending‚Ä¶' : 'üì® Send to Chat' }}
              </button>
            </div>
          }
        </div>
      </div>

    </div><!-- /chat-body -->
  </div>
}

